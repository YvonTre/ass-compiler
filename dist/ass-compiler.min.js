(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?e(exports):typeof define==="function"&&define.amd?define(["exports"],e):e(t.assCompiler={})})(this,function(t){"use strict";function f(t){var e=t.toLowerCase().trim().split(/\s*;\s*/);if(e[0]==="banner"){return{name:e[0],delay:e[1]*1||0,leftToRight:e[2]*1||0,fadeAwayWidth:e[3]*1||0}}if(/^scroll\s/.test(e[0])){return{name:e[0],y1:Math.min(e[1]*1,e[2]*1),y2:Math.max(e[1]*1,e[2]*1),delay:e[3]*1||0,fadeAwayHeight:e[4]*1||0}}return null}function y(t){return t.toLowerCase().replace(/([+-]?(?:\d+(?:\.\d*)?|\.\d+)(?:e[+-]?\d+)?)/g," $1 ").replace(/([mnlbspc])/g," $1 ").trim().replace(/\s+/g," ").split(/\s(?=[mnlbspc])/).map(function(t){return t.split(" ").filter(function(t,e){return!(e&&isNaN(t*1))})})}var e=["b","i","u","s","fsp","k","K","kf","ko","kt","fe","q","p","pbo","a","an","fscx","fscy","fax","fay","frx","fry","frz","fr","be","blur","bord","xbord","ybord","shad","xshad","yshad"];var x=e.map(function(t){return{name:t,regex:new RegExp("^"+t+"-?\\d")}});function S(t){var e;var r={};for(var a=0;a<x.length;a++){var i=x[a];var n=i.name;var s=i.regex;if(s.test(t)){r[n]=t.slice(n.length)*1;return r}}if(/^fn/.test(t)){r.fn=t.slice(2)}else if(/^r/.test(t)){r.r=t.slice(1)}else if(/^fs[\d+-]/.test(t)){r.fs=t.slice(2)}else if(/^\d?c&?H?[0-9a-f]+|^\d?c$/i.test(t)){var l=t.match(/^(\d?)c&?H?(\w*)/);var f=l[1];var o=l[2];r["c"+(f||1)]=o&&("000000"+o).slice(-6)}else if(/^\da&?H?[0-9a-f]+/i.test(t)){var v=t.match(/^(\d)a&?H?(\w\w)/);var c=v[1];var u=v[2];r["a"+c]=u}else if(/^alpha&?H?[0-9a-f]+/i.test(t)){e=t.match(/^alpha&?H?([0-9a-f]+)/i),r.alpha=e[1];r.alpha=("00"+r.alpha).slice(-2)}else if(/^(?:pos|org|move|fad|fade)\(/.test(t)){var p=t.match(/^(\w+)\((.*?)\)?$/);var h=p[1];var d=p[2];r[h]=d.trim().split(/\s*,\s*/).map(Number)}else if(/^i?clip/.test(t)){var m=t.match(/^i?clip\((.*?)\)?$/)[1].trim().split(/\s*,\s*/);r.clip={inverse:/iclip/.test(t),scale:1,drawing:null,dots:null};if(m.length===1){r.clip.drawing=y(m[0])}if(m.length===2){r.clip.scale=m[0]*1;r.clip.drawing=y(m[1])}if(m.length===4){r.clip.dots=m.map(Number)}}else if(/^t\(/.test(t)){var g=t.match(/^t\((.*?)\)?$/)[1].trim().replace(/\\.*/,function(t){return t.replace(/,/g,"\n")}).split(/\s*,\s*/);if(!g[0]){return r}r.t={t1:0,t2:0,accel:1,tags:g[g.length-1].replace(/\n/g,",").split("\\").slice(1).map(S)};if(g.length===2){r.t.accel=g[0]*1}if(g.length===3){r.t.t1=g[0]*1;r.t.t2=g[1]*1}if(g.length===4){r.t.t1=g[0]*1;r.t.t2=g[1]*1;r.t.accel=g[2]*1}}return r}function s(t){var e=[];var r=0;var a="";for(var i=0;i<t.length;i++){var n=t[i];if(n==="("){r++}if(n===")"){r--}if(r<0){r=0}if(!r&&n==="\\"){if(a){e.push(a)}a=""}else{a+=n}}e.push(a);return e.map(S)}function o(t){var e=t.split(/{([^{}]*?)}/);var r=[];if(e[0].length){r.push({tags:[],text:e[0],drawing:[]})}for(var a=1;a<e.length;a+=2){var i=s(e[a]);var n=i.reduce(function(t,e){return e.p===undefined?t:!!e.p},false);r.push({tags:i,text:n?"":e[a+1],drawing:n?y(e[a+1]):[]})}return{raw:t,combined:r.map(function(t){return t.text}).join(""),parsed:r}}function v(t){var e=t.split(":");return e[0]*3600+e[1]*60+e[2]*1}function m(t,e){var r=t.split(",");if(r.length>e.length){var a=r.slice(e.length-1).join();r=r.slice(0,e.length-1);r.push(a)}var i={};for(var n=0;n<r.length;n++){var s=e[n];var l=r[n].trim();switch(s){case"Layer":case"MarginL":case"MarginR":case"MarginV":i[s]=l*1;break;case"Start":case"End":i[s]=v(l);break;case"Effect":i[s]=f(l);break;case"Text":i[s]=o(l);break;default:i[s]=l}}return i}function g(t){return t.match(/Format\s*:\s*(.*)/i)[1].split(/\s*,\s*/)}function b(t){return t.match(/Style\s*:\s*(.*)/i)[1].split(/\s*,\s*/)}function i(t){var e={info:{},styles:{format:[],style:[]},events:{format:[],comment:[],dialogue:[]}};var r=t.split(/\r?\n/);var a=0;for(var i=0;i<r.length;i++){var n=r[i].trim();if(/^;/.test(n)){continue}if(/^\[Script Info\]/i.test(n)){a=1}else if(/^\[V4\+? Styles\]/i.test(n)){a=2}else if(/^\[Events\]/i.test(n)){a=3}else if(/^\[.*\]/.test(n)){a=0}if(a===0){continue}if(a===1){if(/:/.test(n)){var s=n.match(/(.*?)\s*:\s*(.*)/);var l=s[1];var f=s[2];e.info[l]=f}}if(a===2){if(/^Format\s*:/i.test(n)){e.styles.format=g(n)}if(/^Style\s*:/i.test(n)){e.styles.style.push(b(n))}}if(a===3){if(/^Format\s*:/i.test(n)){e.events.format=g(n)}if(/^(?:Comment|Dialogue)\s*:/i.test(n)){var o=n.match(/^(\w+?)\s*:\s*(.*)/i);var v=o[1];var c=o[2];e.events[v.toLowerCase()].push(m(c,e.events.format))}}}return e}var T=Object.assign||function t(e){var r=[],a=arguments.length-1;while(a-- >0)r[a]=arguments[a+1];for(var i=0;i<r.length;i++){if(!r[i]){continue}var n=Object.keys(r[i]);for(var s=0;s<n.length;s++){e[n[s]]=r[i][n[s]]}}return e};function c(t){var e={type:null,prev:null,next:null,points:[]};if(/[mnlbs]/.test(t[0])){e.type=t[0].toUpperCase().replace("N","L").replace("B","C")}for(var r=t.length-!(t.length&1),a=1;a<r;a+=2){e.points.push({x:t[a]*1,y:t[a+1]*1})}return e}function u(t){if(!t.points.length||!t.type){return false}if(/C|S/.test(t.type)&&t.points.length<3){return false}return true}function p(t){var e;var a=Infinity;var i=Infinity;var n=-Infinity;var s=-Infinity;(e=[]).concat.apply(e,t.map(function(t){var e=t.points;return e})).forEach(function(t){var e=t.x;var r=t.y;a=Math.min(a,e);i=Math.min(i,r);n=Math.max(n,e);s=Math.max(s,r)});return{minX:a,minY:i,width:n-a,height:s-i}}function h(t,e,r){var a=[];var i=[0,2/3,1/3,0];var n=[0,1/3,2/3,0];var s=[0,1/6,2/3,1/6];var l=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]};var f=[t[t.length-1].x,t[0].x,t[1].x,t[2].x];var o=[t[t.length-1].y,t[0].y,t[1].y,t[2].y];a.push({type:e==="M"?"M":"L",points:[{x:l(s,f),y:l(s,o)}]});for(var v=3;v<t.length;v++){f=[t[v-3].x,t[v-2].x,t[v-1].x,t[v].x];o=[t[v-3].y,t[v-2].y,t[v-1].y,t[v].y];a.push({type:"C",points:[{x:l(i,f),y:l(i,o)},{x:l(n,f),y:l(n,o)},{x:l(s,f),y:l(s,o)}]})}if(r==="L"||r==="C"){var c=t[t.length-1];a.push({type:"L",points:[{x:c.x,y:c.y}]})}return a}function d(t){return t.map(function(t){var e=t.type;var r=t.points;return e+r.map(function(t){var e=t.x;var r=t.y;return e+","+r}).join(",")}).join("")}function j(t){var e;var r=[];var a=0;while(a<t.length){var i=t[a];var n=c(i);if(u(n)){if(n.type==="S"){var s=(r[a-1]||{points:[{x:0,y:0}]}).points.slice(-1)[0];var l=s.x;var f=s.y;n.points.unshift({x:l,y:f})}if(a){n.prev=r[a-1].type;r[a-1].next=n.type}r.push(n);a++}else{if(a&&r[a-1].type==="S"){var o={p:n.points,c:r[a-1].points.slice(0,3)};r[a-1].points=r[a-1].points.concat((o[i[0]]||[]).map(function(t){var e=t.x;var r=t.y;return{x:e,y:r}}))}t.splice(a,1)}}var v=(e=[]).concat.apply(e,r.map(function(t){var e=t.type;var r=t.points;var a=t.prev;var i=t.next;return e==="S"?h(r,a,i):{type:e,points:r}}));return T({instructions:v,d:d(v)},p(r))}var R=["fs","clip","c1","c2","c3","c4","a1","a2","a3","a4","alpha","fscx","fscy","fax","fay","frx","fry","frz","fr","be","blur","bord","xbord","ybord","shad","xshad","yshad"];function $(t,e,r){var a,i,n;if(r===void 0)r={};var s=t[e];if(s===undefined){return null}if(e==="pos"||e==="org"){return s.length===2?(a={},a[e]={x:s[0],y:s[1]},a):null}if(e==="move"){var l=s[0];var f=s[1];var o=s[2];var v=s[3];var c=s[4];if(c===void 0)c=0;var u=s[5];if(u===void 0)u=0;return s.length===4||s.length===6?{move:{x1:l,y1:f,x2:o,y2:v,t1:c,t2:u}}:null}if(e==="fad"||e==="fade"){if(s.length===2){var p=s[0];var h=s[1];return{fade:{type:"fad",t1:p,t2:h}}}if(s.length===7){var d=s[0];var m=s[1];var g=s[2];var y=s[3];var x=s[4];var S=s[5];var b=s[6];return{fade:{type:"fade",a1:d,a2:m,a3:g,t1:y,t2:x,t3:S,t4:b}}}return null}if(e==="clip"){var w=s.inverse;var M=s.scale;var k=s.drawing;var C=s.dots;if(k){return{clip:{inverse:w,scale:M,drawing:j(k),dots:C}}}if(C){var F=C[0];var O=C[1];var L=C[2];var N=C[3];return{clip:{inverse:w,scale:M,drawing:k,dots:{x1:F,y1:O,x2:L,y2:N}}}}return null}if(/^[xy]?(bord|shad)$/.test(e)){s=Math.max(s,0)}if(e==="bord"){return{xbord:s,ybord:s}}if(e==="shad"){return{xshad:s,yshad:s}}if(/^c\d$/.test(e)){return i={},i[e]=s||r[e],i}if(e==="alpha"){return{a1:s,a2:s,a3:s,a4:s}}if(e==="fr"){return{frz:s}}if(e==="fs"){return{fs:/^\+|-/.test(s)?(s*1>-10?1+s/10:1)*r.fs:s*1}}if(e==="t"){var P=s.t1;var I=s.accel;var D=s.tags;var E=s.t2||(r.end-r.start)*1e3;var H={};D.forEach(function(t){var e=Object.keys(t)[0];if(~R.indexOf(e)&&!(e==="clip"&&!t[e].dots)){T(H,$(t,e,r))}});return{t:{t1:P,t2:E,accel:I,tag:H}}}return n={},n[e]=s,n}var A=[null,1,2,3,null,7,8,9,null,4,5,6];var B=["r","a","an","pos","org","move","fade","fad","clip"];function W(t,e){return{name:t,borderStyle:e[t].style.BorderStyle,tag:e[t].tag,fragments:[]}}function w(t){var e=t.styles;var r=t.name;var a=t.parsed;var i=t.start;var n=t.end;var s;var l;var f;var o;var v;var c;var u=[];var p=W(r,e);var h={};for(var d=0;d<a.length;d++){var m=a[d];var g=m.tags;var y=m.text;var x=m.drawing;var S=void 0;for(var b=0;b<g.length;b++){var w=g[b];S=w.r===undefined?S:w.r}var M={tag:S===undefined?JSON.parse(JSON.stringify(h)):{},text:y,drawing:x.length?j(x):null};for(var k=0;k<g.length;k++){var C=g[k];s=s||A[C.a||0]||C.an;l=l||$(C,"pos");f=f||$(C,"org");o=o||$(C,"move");v=v||$(C,"fade")||$(C,"fad");c=$(C,"clip")||c;var F=Object.keys(C)[0];if(F&&!~B.indexOf(F)){var O=p.tag;var L=O.c1;var N=O.c2;var P=O.c3;var I=O.c4;var D=h.fs||p.tag.fs;var E=$(C,F,{start:i,end:n,c1:L,c2:N,c3:P,c4:I,fs:D});if(F==="t"){M.tag.t=M.tag.t||[];M.tag.t.push(E.t)}else{T(M.tag,E)}}}h=M.tag;if(S!==undefined){u.push(p);p=W(e[S]?S:r,e)}if(M.text||M.drawing){var H=p.fragments[p.fragments.length-1]||{};if(H.text&&M.text&&!Object.keys(M.tag).length){H.text+=M.text}else{p.fragments.push(M)}}}u.push(p);return T({alignment:s,slices:u},l,f,o,v,c)}function n(t){var e=t.styles;var r=t.dialogues;var a=Infinity;var i=[];for(var n=0;n<r.length;n++){var s=r[n];if(s.Start>=s.End){continue}if(!e[s.Style]){s.Style="Default"}var l=e[s.Style].style;var f=w({styles:e,name:s.Style,parsed:s.Text.parsed,start:s.Start,end:s.End});var o=f.alignment||l.Alignment;a=Math.min(a,s.Layer);i.push(T({layer:s.Layer,start:s.Start,end:s.End,margin:{left:s.MarginL||l.MarginL,right:s.MarginR||l.MarginR,vertical:s.MarginV||l.MarginV},effect:s.Effect},f,{alignment:o}))}for(var v=0;v<i.length;v++){i[v].layer-=a}return i.sort(function(t,e){return t.start-e.start||t.end-e.end})}var l={Name:"Default",Fontname:"Arial",Fontsize:"20",PrimaryColour:"&H00FFFFFF&",SecondaryColour:"&H000000FF&",OutlineColour:"&H00000000&",BackColour:"&H00000000&",Bold:"0",Italic:"0",Underline:"0",StrikeOut:"0",ScaleX:"100",ScaleY:"100",Spacing:"0",Angle:"0",BorderStyle:"1",Outline:"2",Shadow:"2",Alignment:"2",MarginL:"10",MarginR:"10",MarginV:"10",Encoding:"1"};function M(t){if(/^(&|H|&H)[0-9a-f]{6,}/i.test(t)){var e=t.match(/&?H?([0-9a-f]{2})?([0-9a-f]{6})/i);var r=e[1];var a=e[2];return[r||"00",a]}var i=parseInt(t,10);if(!isNaN(i)){var n=-2147483648;var s=2147483647;if(i<n){return["00","000000"]}var l=n<=i&&i<=s?("00000000"+(i<0?i+4294967296:i).toString(16)).slice(-8):String(i).slice(0,8);return[l.slice(0,2),l.slice(2)]}return["00","000000"]}function k(t){var d=t.info;var e=t.style;var a=t.format;var r=t.defaultStyle;var m={};var g=[T({},l,r,{Name:"Default"})].concat(e.map(function(t){var e={};for(var r=0;r<a.length;r++){e[a[r]]=t[r]}return e}));var i=function(t){var e=g[t];if(/^(\*+)Default$/.test(e.Name)){e.Name="Default"}Object.keys(e).forEach(function(t){if(t!=="Name"&&t!=="Fontname"&&!/Colour/.test(t)){e[t]*=1}});var r=M(e.PrimaryColour);var a=r[0];var i=r[1];var n=M(e.SecondaryColour);var s=n[0];var l=n[1];var f=M(e.OutlineColour);var o=f[0];var v=f[1];var c=M(e.BackColour);var u=c[0];var p=c[1];var h={fn:e.Fontname,fs:e.Fontsize,c1:i,a1:a,c2:l,a2:s,c3:v,a3:o,c4:p,a4:u,b:Math.abs(e.Bold),i:Math.abs(e.Italic),u:Math.abs(e.Underline),s:Math.abs(e.StrikeOut),fscx:e.ScaleX,fscy:e.ScaleY,fsp:e.Spacing,frz:e.Angle,xbord:e.Outline,ybord:e.Outline,xshad:e.Shadow,yshad:e.Shadow,q:/^[0-3]$/.test(d.WrapStyle)?d.WrapStyle*1:2};m[e.Name]={style:e,tag:h}};for(var n=0;n<g.length;n++)i(n);return m}function r(t,e){if(e===void 0)e={};var r=i(t);var a=k({info:r.info,style:r.styles.style,format:r.styles.format,defaultStyle:e.defaultStyle||{}});return{info:r.info,width:r.info.PlayResX*1||null,height:r.info.PlayResY*1||null,collisions:r.info.Collisions||"Normal",styles:a,dialogues:n({styles:a,dialogues:r.events.dialogue})}}var a=function t(){this.startTimestamps=[];this.endTimestamps=[]};a.prototype.insert=function t(e,r){var a=[e,r].sort();var i=a[0];var n=a[1];var s=this.checkWithIndex(i);var l=s.in;var f=s.index;var o=this.checkWithIndex(n);var v=o.in;var c=o.index;if(!l&&!v&&f===c){this.startTimestamps.splice(f+1,0,i);this.endTimestamps.splice(c+1,0,n)}else{if(!l){this.startTimestamps[f+1]=i}this.endTimestamps[l?f:c]=v?this.endTimestamps[c]:r;var u=f===c?0:f+1;var p=c-f-(l?0:1);this.startTimestamps.splice(u,p);this.endTimestamps.splice(u,p)}};a.prototype.checkWithIndex=function t(a){var e=this.startTimestamps.findIndex(function(t,e,r){if(r.length===e+1){return t<=a}return t<=a&&r[e+1]>=a});return{in:e!==-1&&this.endTimestamps[e]>=a,index:e}};a.prototype.check=function t(e){return this.checkWithIndex(e).in};var C=function t(){this.lastLines=[];this.timeSegments=new a;this.info={};this.styleFormat=[];this.parsedStyle=[];this.eventFormat=[];this.newParsedComments=[];this.newParsedDialogues=[];this.parsingState=0;this.compiledStyles={};this.compiledDialogues=[]};var F={compiled:{configurable:true}};C.getParsingState=function t(e){if(/^\[Script Info\]/i.test(e)){return 1}if(/^\[V4\+? Styles\]/i.test(e)){return 2}if(/^\[Events\]/i.test(e)){return 3}if(/^\[.*\]/.test(e)){return 0}return-1};C.prototype.parse=function t(e){var r=this;var a;var i=e.split(/\r?\n/).filter(function(t){return!r.lastLines.includes(t)});(a=this.lastLines).push.apply(a,i);for(var n=0;n<i.length;n++){var s=i[n].trim();if(/^;/.test(s)){continue}var l=C.getParsingState(s);if(l===0){continue}else if(l===-1){l=this.parsingState}else{this.parsingState=l}switch(l){default:continue;case 1:{if(/:/.test(s)){var f=s.match(/(.*?)\s*:\s*(.*)/);var o=f[1];var v=f[2];this.info[o]=v}break}case 2:{if(/^Format\s*:/i.test(s)){this.styleFormat=g(s)}if(/^Style\s*:/i.test(s)){this.parsedStyle.push(b(s))}break}case 3:{if(/^Format\s*:/i.test(s)){this.eventFormat=g(s)}if(/^(?:Comment|Dialogue)\s*:/i.test(s)){var c=s.match(/^(\w+?)\s*:\s*(.*)/i);var u=c[1];var p=c[2];var h=u.toLowerCase();var d=m(p,this.eventFormat);this.timeSegments.insert(d.Start,d.End);if(h==="comment"){this.newParsedComments.push(d)}if(h==="dialogue"){this.newParsedDialogues.push(d)}}break}}}};C.prototype.compile=function t(e){var r;this.parse(e);this.compiledStyles=k({info:this.info,style:this.parsedStyle,format:this.styleFormat,defaultStyle:{}});(r=this.compiledDialogues).push.apply(r,n({styles:this.compiledStyles,dialogues:this.newParsedDialogues}));this.newParsedDialogues=[]};F.compiled.get=function(){return{info:this.info,width:this.info.PlayResX*1||null,height:this.info.PlayResY*1||null,collisions:this.info.Collisions||"Normal",styles:this.compiledStyles,dialogues:this.compiledDialogues}};Object.defineProperties(C.prototype,F);t.parse=i;t.compile=r;t.AssStream=C;Object.defineProperty(t,"__esModule",{value:true})});